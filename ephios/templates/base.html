{% load webpush_notifications %}
{% load signal_extras %}
{% load settings_extras %}
{% load statici18n %}
{% load i18n %}
{% load static %}
{% load compress %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="created" content="{% now "c" %}">
        <title>{% block title %}{{ platform_name }}{% endblock %} - {{ platform_name }}</title>
        <link rel="shortcut icon" type="image/x-icon" href="{% static "appicon-svg-prod.svg"|as_brand_static_path %}">
        <link rel="manifest" href="/manifest.json">

        <meta name="service-worker-js" content="{% url 'service_worker' %}">
        <meta name="django-webpush-vapid-key" content="{{ VAPID_PUBLIC_KEY }}">

    <!-- Add to homescreen for Chrome on Android -->
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="application-name" content="{{ platform_name }}">

    <!-- Chrome for Android theme color -->
        <meta name="theme-color" content="{{ brand_color }}">

    <!-- Add to homescreen for Safari on iOS -->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-title" content="{{ platform_name }}">
        <meta name="apple-mobile-web-app-status-bar-style" content="#fff">

        {% for icon in PWA_APP_ICONS %}
            <link rel="apple-touch-icon" href="{{ icon.src }}" sizes="{{ icon.sizes }}">
        {% endfor %}

        {% for splash in PWA_APP_SPLASH_SCREEN %}
            <link href="{{ splash.src }}" media="{{ splash.media }}" rel="apple-touch-startup-image"/>
        {% endfor %}

    <!-- Tile for Win8 -->
        <meta name="msapplication-TileColor" content="#fff">
        {% with PWA_APP_ICONS|last as icon %}
            <meta name="msapplication-TileImage" content="{{ icon.src }}">
            <link rel="icon" sizes="{{ icon.sizes }}" href="{{ icon.src }}">
        {% endwith %}

    {# main.scss contains custom ephios styles, bootstrap and #}
    {# select2-bootstrap theme (which it why it must come after select2) #}
        {% compress css %}
            <link type="text/css" rel="stylesheet" href="{% static "select2/css/select2.min.css" %}">
            <link type="text/css" rel="stylesheet" href="{% static "fontawesome/css/all.css" %}">
            <link type="text/x-scss" href="{% static 'ephios/scss/main.scss' %}" rel="stylesheet">
            {% block css %}{% endblock %}
        {% endcompress %}

        {% compress js %}
            {% if DEBUG %}
                <script type="text/javascript" src="{% static "vuejs/vue.global.js" %}"></script>
            {% else %}
                <script type="text/javascript" src="{% static "vuejs/vue.global.prod.js" %}"></script>
            {% endif %}
            <script id="webpush-js" type="text/javascript" src="{% static 'webpush/webpush.js' %}"></script>
            <script type="text/javascript" src="{% static "jquery/js/jquery-3.7.1.min.js" %}"></script>
            <script type="text/javascript" src="{% static "bootstrap/js/bootstrap.bundle.min.js" %}"></script>
            <script type="text/javascript" src="{% static "select2/js/select2.js" %}"></script>
            <script type="text/javascript" src="{% static "django_select2/django_select2.js" %}"></script>
            <script type="text/javascript" src="{% statici18n LANGUAGE_CODE %}"></script>
            <script type="text/javascript" src="{% static "select2/js/i18n/"|add:LANGUAGE_CODE|add:".js" %}"></script>
            <script type="text/javascript" src="{% static "ephios/js/formset/formset.js" %}"></script>
            <script type="text/javascript" src="{% static "ephios/js/main.js" %}"></script>
            {% block javascript %}{% endblock %}
        {% endcompress %}
        {% collect_insert_html_signal "head" %}
        {% block html_head %}
        {% endblock %}
    </head>

    <body data-pwa-network="online" data-user-is-authenticated="{{ request.user.is_authenticated }}">
        <header>
            <nav class="navbar navbar-expand-lg navbar-light bg-light shadow">
                <div class="container">
                    <a class="navbar-brand" href="/">
                        <img src="{% static "nav_logo.png"|as_brand_static_path %}"
                             alt="{{ platform_name }}"
                             class="d-inline-block" width="75">
                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                            data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                            aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
            {# empty/replace the nav bar block for use in e.g. error page templates #}
                    {% block main_nav %}
                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            {% if user.is_authenticated %}
                                <ul class="navbar-nav me-auto">
                                    {% with url_name=request.resolver_match.url_name %}
                                        <li class="nav-item {% if url_name == "index" %}active{% endif %}">
                                            <a class="nav-link" href="{% url "core:home" %}">{% translate "Home" %}</a>
                                        </li>
                                        <li class="nav-item {% if url_name == "event_list" %}active{% endif %}">
                                            <a class="nav-link"
                                               href="{% url "core:event_list" %}">{% translate "Events" %}</a>
                                        </li>
                                        {% for item in nav %}
                                            <li class="nav-item {% if item.active %}active{% endif %}"
                                                {% include "core/fragments/attrs.html" with item=item %}>
                                                <a class="nav-link" href="{{ item.url }}">{{ item.label }}</a>
                                            </li>
                                        {% endfor %}
                                        {% for group, items in nav_groups.items %}
                                            <li class="nav-item dropdown">
                                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown-{{ group }}"
                                                   role="button"
                                                   data-bs-toggle="dropdown" aria-expanded="false">
                                                    {{ group }}
                                                </a>
                                                <div class="dropdown-menu" aria-labelledby="navbarDropdownAccount">
                                                    {% for item in items %}
                                                        <a class="dropdown-item" href="{{ item.url }}"
                                                           {% include "core/fragments/attrs.html" with item=item %}>
                                                            {{ item.label }}
                                                        </a>
                                                    {% endfor %}
                                                </div>
                                            </li>
                                        {% endfor %}
                                    {% endwith %}
                                </ul>
                                <ul class="navbar-nav ms-auto">
                                    {% collect_insert_html_signal "navbar" %}
                                    <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownAccount" role="button"
                                           data-bs-toggle="dropdown" aria-expanded="false">
                                            {{ user.get_full_name }}
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownAccount">
                                            {% for item in nav_userprofile %}
                                                <a class="dropdown-item" {% include "core/fragments/attrs.html" with item=item %}
                                                   href="{{ item.url }}">{{ item.label }}</a>
                                            {% endfor %}
                                            <a class="dropdown-item"
                                               href="{% url "core:workinghours_own" %}">{% translate "Working hours" %}</a>
                                            <a class="dropdown-item"
                                               href="{% url "core:notification_list" %}">{% translate "Notifications" %}</a>
                                            <a class="dropdown-item"
                                               href="{% url "core:settings_personal_data" %}">{% translate "Settings" %}</a>
                                            <a class="dropdown-item" id="logout-link"
                                               href="{% url "core:oidc_logout" %}">{% translate "Logout" %}</a>
                                        </div>
                                    </li>
                                </ul>
                            {% endif %}
                        </div>
                    {% endblock %}
                </div>
            </nav>
            <div id="unloading-spinner" class="d-none">
                <div class="spinner-grow" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </header>
        <div class="container container-main pt-3">
            <main class="row blur-on-unload">
                <div class="col-12">
                    <div id="messages">
                        {% for message in messages %}
                            <div class="alert {{ message.tags }} alert-dismissible" role="alert">
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                {{ message }}
                            </div>
                        {% endfor %}
                        {% block messages %}{% endblock %}
                    </div>
                    {% block content %}{% endblock %}
                </div>
            </main>
            <footer class="row blur-on-unload mt-2">
                <div class="col-md-12 text-center">
                    <small>
                        {% for label, url in footer.items %}
                            <a href="{{ url }}">{{ label }}</a> Â·
                        {% endfor %}
                        <span class="text-body-secondary">
                            {% blocktranslate trimmed with brand='<a href="https://ephios.de/" rel="noreferrer" target="_blank">ephios</a>' %}
                                powered by {{ brand }}
                            {% endblocktranslate %}
                            <samp>v{{ ephios_version|default_if_none:"" }}</samp>
                        </span>
                    </small>
                </div>
            </footer>
            <div id="pwaAndroidOffcanvas" class="offcanvas offcanvas-bottom">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="pwaOffcanvasLabel">
                        {% blocktranslate trimmed with platform_name=platform_name %}
                            Install {{ platform_name }} app
                        {% endblocktranslate %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <p class="pb-2">{% blocktranslate trimmed with platform_name=platform_name %}
                        You can install {{ platform_name }} on your device and use it like any other app!
                    {% endblocktranslate %} {% translate "Simply click the button below to continue." %}</p>
                    <button id="pwaInstall" class="btn btn-primary">{% blocktranslate with platform_name=platform_name %}Install {{ platform_name }}{% endblocktranslate %}</button>
                </div>
            </div>
            <div id="pwaAppleOffcanvas" class="offcanvas offcanvas-bottom">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="pwaOffcanvasLabel">{% blocktranslate trimmed with platform_name=platform_name %}
                        Install {{ platform_name }} app
                    {% endblocktranslate %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <p class="pb-2">{% blocktranslate trimmed with platform_name=platform_name %}
                        You can install {{ platform_name }} on your device and use it like any other app!
                    {% endblocktranslate %} {%translate "Simply follow the steps below." %}</p>
                    <hr>
                    <div class="container">
                        <div class="row align-items-center">
                            <div class="col-2">
                                <div class="p-2">
                                    <svg id="pwa-safari" viewBox="0 0 20.283 19.932" width="24" height="24">
                                        <g fill="currentColor"><path d="M9.96 19.922c5.45 0 9.962-4.522 9.962-9.961C19.922 4.51 15.4 0 9.952 0 4.511 0 0 4.512 0 9.96c0 5.44 4.521 9.962 9.96 9.962Zm0-1.66A8.26 8.26 0 0 1 1.67 9.96c0-4.61 3.672-8.3 8.281-8.3 4.61 0 8.31 3.69 8.31 8.3 0 4.61-3.69 8.3-8.3 8.3Z"/><path d="m5.87 14.883 5.605-2.735a1.47 1.47 0 0 0 .683-.673l2.725-5.596c.312-.664-.166-1.182-.85-.84L8.447 7.764c-.302.136-.508.341-.674.673L5.03 14.043c-.312.645.196 1.152.84.84Zm4.09-3.72A1.19 1.19 0 0 1 8.77 9.97c0-.664.527-1.201 1.19-1.201a1.2 1.2 0 0 1 1.202 1.2c0 .655-.537 1.192-1.201 1.192Z"/></g>
                                    </svg>
                                </div>
                            </div>
                            <div class="col">{% translate "Open in your main browser" %}</div>
                        </div>
                        <div class="row align-items-center">
                            <div class="col-2">
                                <div class="p-2">
                                    <svg id="safari-dots" width="22" height="24" viewBox="0 0 24 24">
                                        <circle cx="2" cy="12" r="2" fill="currentColor"/>
                                        <circle cx="12" cy="12" r="2" fill="currentColor"/>
                                        <circle cx="22" cy="12" r="2" fill="currentColor"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="col">{% translate "Press More if no Share icon" %}</div>
                        </div>
                        <div class="row align-items-center">
                            <div class="col-2">
                                <div class="p-2">
                                    <svg id="pwa-share" width="25" height="32" viewBox="0 0 17.695 26.475">
                                        <g fill="currentColor"><path d="M17.334 10.762v9.746c0 2.012-1.025 3.027-3.066 3.027H3.066C1.026 23.535 0 22.52 0 20.508v-9.746C0 8.75 1.025 7.734 3.066 7.734h2.94v1.573h-2.92c-.977 0-1.514.527-1.514 1.543v9.57c0 1.015.537 1.543 1.514 1.543h11.152c.967 0 1.524-.527 1.524-1.543v-9.57c0-1.016-.557-1.543-1.524-1.543h-2.91V7.734h2.94c2.04 0 3.066 1.016 3.066 3.028Z"/><path d="M8.662 15.889c.42 0 .781-.352.781-.762V5.097l-.058-1.464.654.693 1.484 1.582a.698.698 0 0 0 .528.235c.4 0 .713-.293.713-.694 0-.205-.088-.361-.235-.508l-3.3-3.183c-.196-.196-.362-.264-.567-.264-.195 0-.361.069-.566.264L4.795 4.94a.681.681 0 0 0-.225.508c0 .4.293.694.703.694.186 0 .4-.079.538-.235l1.474-1.582.664-.693-.058 1.465v10.029c0 .41.351.762.771.762Z"/></g>
                                    </svg>
                                </div>
                            </div>
                            <div class="col">{% translate "Press Share in Navigation bar" %}</div>
                        </div>
                        <div class="row align-items-center">
                            <div class="col-2">
                                <div class="m-2">
                                    <svg id="pwa-add" width="25" height="25">
                                        <g><path d="m23.40492,1.60784c-1.32504,-1.32504 -3.19052,-1.56912 -5.59644,-1.56912l-10.65243,0c-2.33622,0 -4.2017,0.24408 -5.5267,1.56912c-1.32504,1.34243 -1.56911,3.17306 -1.56911,5.50924l0,10.5827c0,2.40596 0.22665,4.254 1.55165,5.57902c1.34246,1.32501 3.19052,1.5691 5.59647,1.5691l10.60013,0c2.40592,0 4.2714,-0.24408 5.59644,-1.5691c1.325,-1.34245 1.55166,-3.17306 1.55166,-5.57902l0,-10.51293c0,-2.40596 -0.22666,-4.25401 -1.55166,-5.57901zm-0.38355,5.21289l0,11.24518c0,1.51681 -0.20924,2.94643 -1.02865,3.78327c-0.83683,0.83685 -2.30134,1.0635 -3.81815,1.0635l-11.33234,0c-1.51681,0 -2.96386,-0.22665 -3.80073,-1.0635c-0.83683,-0.83684 -1.04607,-2.26646 -1.04607,-3.78327l0,-11.19288c0,-1.5517 0.20924,-3.01617 1.02865,-3.85304c0.83687,-0.83683 2.31876,-1.04607 3.87042,-1.04607l11.28007,0c1.51681,0 2.98132,0.22666 3.81815,1.06353c0.81941,0.81941 1.02865,2.26645 1.02865,3.78327zm-10.53039,12.08205c0.64506,0 1.02861,-0.43586 1.02861,-1.13326l0,-4.34117l4.53294,0c0.66252,0 1.13326,-0.36613 1.13326,-0.99376c0,-0.64506 -0.43586,-1.02861 -1.13326,-1.02861l-4.53294,0l0,-4.53294c0,-0.6974 -0.38355,-1.13326 -1.02861,-1.13326c-0.62763,0 -0.99376,0.45332 -0.99376,1.13326l0,4.53294l-4.51552,0c-0.69737,0 -1.15069,0.38355 -1.15069,1.02861c0,0.62763 0.48817,0.99376 1.15069,0.99376l4.51552,0l0,4.34117c0,0.66252 0.36613,1.13326 0.99376,1.13326z" /></g>
                                    </svg>
                                </div>
                            </div>
                            <div class="col">{% translate "Scroll down to &quot;Add to Home Screen&quot;" %}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="notificationOffcanvas" class="offcanvas offcanvas-bottom">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="notificationOffcanvasLabel">{% translate "Activate notifications" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <p>{% blocktranslate trimmed with platform_name=platform_name %}{{ platform_name }} can send you push notifications so that you stay up to date. Do you want to activate them?" {% endblocktranslate %}</p>
                    <button id="webpush-subscribe-button" class="btn btn-sm btn-primary"
                            data-url="{% url "save_webpush_info" %}">
                        {% translate "Subscribe to Push Messaging" %}
                    </button>
                    <div id="webpush-message" hidden></div>
                </div>
            </div>
        </div>
    </body>
</html>
